# CETI Whale Tag - V3

This repository contains the firmware suite for the STM32 based CETI whale tags.

# Building

## Docker

To run the build process in docker run:

```sh
make build
```

to manually run docker

```sh
docker build -t ceti-img . # create image
docker run --rm --volume $(pwd):/ceti-firmware ceti-img make #run make inside image
```

## Local(Linux)

Works with Ubuntu 22.04 or higher

### 1. Initialize subrepositories:

This repository uses submodule. Clone it with the `--recursive` flag:

```
git clone --recursive https://github.com/Project-CETI/ceti-whale-tag-v3-fw.git
```

or

```
git submodule update --init --rcursive
```

### 2. Install dependencies

Required package are listed in [`packages.txt`](packages.txt) and can be install with the following command:

```sh
sudo apt-get update && sudo apt-get install --no-install-recommends -y $(cat ./packages.txt)
```

### Compiling

The .elf file can be compile with the `make` command:

```sh
make # Build with DEBUG configuration
make DEBUG=0 # Build release version of .elf file
```

# Flashing

### Prerequirements:
The requirement for flashing from command line is `STM32_Programmer_CLI`. This software is a CLI version of the [`STM32CubeProgrammer`](https://www.st.com/en/development-tools/stm32cubeprog.html) GUI and is included in that [software suite's download](https://www.st.com/en/development-tools/stm32cubeprog.html#get-software)
### Flashing

```sh
make flash
```

# IDE Integration
## STM32CubeIDE
[Instructions](https://hackaday.com/wp-content/uploads/2017/07/tutorial.pdf) for importing a makefile projects into Eclipse (STM32CubeIDE).

## VSCode
[Instructions](https://stm32world.com/wiki/STM32_development_and_debugging_using_VSCode) for setting up and debugging with VSCode.

# Linting
A lint check is performed by the github CI/CD pipeline. To run a lint check locally on your code prior to pushing to a branch run:
```
make lint
```  

To attempt to automatically resolve linting issues run:
```
make lint_fix
```

# Porting
To improve portability of the code, hardware configuration code generated by `STM32CubeMX` exists in the corresponding [`board/<board_name>`](board/) subdirectory and be targeted via `make BOARD=<board_name>`. Please preserve any device/pin naming conventions and update relavent parts of the [Makefile](Makefile)
